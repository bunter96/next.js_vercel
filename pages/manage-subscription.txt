// /pages/manage-subscription.js
import { useEffect, useState } from 'react';
import { useAuth } from '@/context/AuthContext';

export default function ManageSubscription() {
  const { user, loading } = useAuth();
  const [portalUrl, setPortalUrl] = useState(null);
  const [apiError, setApiError] = useState(null);

  useEffect(() => {
    if (user && user.creem_customer_id) {
      fetch('/api/customer-portal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerId: user.creem_customer_id }),
      })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            setApiError(data.error);
          } else {
            setPortalUrl(data.portalUrl);
          }
        })
        .catch(err => setApiError('Failed to load customer portal'));
    }
  }, [user]);

  useEffect(() => {
    if (portalUrl) {
      window.location.href = portalUrl;
    }
  }, [portalUrl]);

  if (loading) return <p className="text-center text-gray-500">Loading user...</p>;
  if (!user) return <p className="text-center text-red-500">Please log in to view your subscriptions.</p>;
  if (apiError) return <p className="text-center text-red-500">{apiError}</p>;
  if (!user.creem_customer_id) return <p className="text-center text-gray-500">You are not subscribed to any plans.</p>;

  return (
    <div className="p-6 max-w-2xl mx-auto">
      <h1 className="text-2xl font-semibold mb-6 text-gray-800">Your Subscriptions</h1>
      <p className="text-center text-gray-500">Redirecting to Customer Portal...</p>
    </div>
  );
}